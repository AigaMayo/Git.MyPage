# ðŸš€ PIC-Arduino IÂ²Cé€šä¿¡ã®è¿½åŠ ã¨å¤‰æ›´ç‚¹è§£èª¬

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€**PIC18F2550 (ãƒžã‚¹ã‚¿ãƒ¼)** ã¨ **Arduino Nano (ã‚¹ãƒ¬ãƒ¼ãƒ–)** é–“ã« IÂ²C (Inter-Integrated Circuit) é€šä¿¡ã‚’è¿½åŠ ã—ãŸéš›ã®ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«å®šç¾©ã€ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã€ãŠã‚ˆã³å®Ÿè£…ãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

## 1\. ðŸ¤ é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®šç¾©

æ¨™æº–çš„ãªIÂ²Cãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æŽ¡ç”¨ã—ã€ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã«**æ§‹é€ ä½“**ã¨**ãƒã‚§ãƒƒã‚¯ã‚µãƒ **ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

### 1.1. åŸºæœ¬è¨­å®š

| é …ç›® | è¨­å®šå€¤ | å‚™è€ƒ |
| :--- | :--- | :--- |
| **PICå½¹å‰²** | **ãƒžã‚¹ã‚¿ãƒ¼** | é€šä¿¡ã‚’ä¸»å°Žã—ã€ã‚¯ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆ |
| **Arduinoå½¹å‰²** | **ã‚¹ãƒ¬ãƒ¼ãƒ–** | ã‚¢ãƒ‰ãƒ¬ã‚¹ (`0x37`) ã§å¾…ã¡å—ã‘ã€å¿œç­” |
| **ã‚¹ãƒ¬ãƒ¼ãƒ–ã‚¢ãƒ‰ãƒ¬ã‚¹** | **`0x37` (7bit)** | PICã¨Arduinoã§å…±é€š |
| **é€šä¿¡é€Ÿåº¦** | **400kHz** | PICã®`SSPADD = 29`ã§è¨­å®š |
| **ç‰©ç†ãƒ”ãƒ³** | **SDA: RB0 (Pin 21)**, **SCL: RB1 (Pin 22)** | `HardwareProfile.h`ã«å®šç¾©æ¸ˆã¿ |

### 1.2. ãƒ‡ãƒ¼ã‚¿æ§‹é€ ä½“ (ãƒã‚§ãƒƒã‚¯ã‚µãƒ ä»˜ã)

ã™ã¹ã¦ã®é€šä¿¡ã¯ã€ãƒžãƒ«ãƒãƒã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿åž‹ã®**ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã®å•é¡Œã‚’å›žé¿**ã—ã€**ãƒã‚§ãƒƒã‚¯ã‚µãƒ **ã§ä¿¡é ¼æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã€å›ºå®šé•·æ§‹é€ ä½“ã§è¡Œã‚ã‚Œã¾ã™ã€‚

| æ–¹å‘ | æ§‹é€ ä½“å | ã‚µã‚¤ã‚º | ç›®çš„ |
| :--- | :--- | :--- | :--- |
| **PIC â†’ Arduino** | `ControlData_t` | **4 bytes** | PICã®åˆ¶å¾¡æŒ‡ä»¤ï¼ˆç›®æ¨™å€¤ã€ãƒ¢ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’é€ä¿¡ |
| **PIC â† Arduino** | `SensorData_t` | **6 bytes** | Arduinoã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆæ¸©åº¦ã€çŠ¶æ…‹ã‚³ãƒ¼ãƒ‰ãªã©ï¼‰ã‚’å—ä¿¡ |

-----

## 2\. ðŸ“ PIC (ãƒžã‚¹ã‚¿ãƒ¼) å´ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ ã¨å¤‰æ›´ç‚¹

IÂ²Cé€šä¿¡ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åˆ†é›¢ã™ã‚‹ãŸã‚ã€å°‚ç”¨ã®ãƒ‰ãƒ©ã‚¤ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

### 2.1. æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«å | å½¹å‰² | æ¦‚è¦ |
| :--- | :--- | :--- |
| **`arduino_i2c_driver.h`** | **ãƒ˜ãƒƒãƒ€ãƒ¼** | IÂ²Cã‚¢ãƒ‰ãƒ¬ã‚¹ã€`ControlData_t`ã¨`SensorData_t`ã®å®šç¾©ã€é«˜ãƒ¬ãƒ™ãƒ«é–¢æ•°ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— (`send_control_data`, `read_sensor_data`) ã‚’æ ¼ç´ã€‚ |
| **`arduino_i2c_driver.c`** | **ãƒ‰ãƒ©ã‚¤ãƒ** | MSSPãƒ¬ã‚¸ã‚¹ã‚¿ã‚’æ“ä½œã™ã‚‹ä½Žãƒ¬ãƒ™ãƒ«é€šä¿¡é–¢æ•° (`I2C_Master_Write`, `I2C_Master_Read`) ã¨ã€æ§‹é€ ä½“ãƒ™ãƒ¼ã‚¹ã®é«˜ãƒ¬ãƒ™ãƒ«é–¢æ•°ã‚’å®Ÿè£…ã€‚ |

### 2.2. `main.c` ã®ä¿®æ­£ç‚¹

  * `#include "arduino_i2c_driver.h"` ã‚’è¿½åŠ ã€‚

  * `InitializeSystem()`å†…ã®IÂ²CåˆæœŸåŒ–éƒ¨åˆ†ã‚’ã€æ–°ã—ã„ãƒ‰ãƒ©ã‚¤ãƒã®é–¢æ•°ã«ç½®ãæ›ãˆã€ãƒ”ãƒ³è¨­å®šã‚’çµ±ä¸€ã€‚

    ```c
    // æ—¢å­˜ã® InitI2C() å‘¼ã³å‡ºã—ã‚’ç½®ãæ›ãˆã‚‹ã‹ã€éš£ã«è¿½è¨˜
    Init_I2C_Arduino(); 
    ```

  * ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—å†…ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (`TxControlData`ã‚„`RxSensorData`) ã‚’æ›´æ–°ãƒ»å‚ç…§ã—ã€ä»¥ä¸‹ã®é«˜ãƒ¬ãƒ™ãƒ«é–¢æ•°ã‚’å®šæœŸçš„ã«å‘¼ã³å‡ºã™ã€‚

    ```c
    send_control_data(); // PIC -> Arduino
    read_sensor_data();  // PIC <- Arduino
    ```

### 2.3. PICå´ã®ä¸»è¦ãªãƒ­ã‚¸ãƒƒã‚¯

PICå´ã®IÂ²Cãƒ‰ãƒ©ã‚¤ãƒã¯ã€MSSPãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’åˆ¶å¾¡ã—ã€æ§‹é€ ä½“ã®å…ˆé ­ãƒã‚¤ãƒ³ã‚¿ã¨ã‚µã‚¤ã‚ºã‚’å—ã‘å–ã£ã¦ãƒã‚¤ãƒˆåˆ—ã¨ã—ã¦ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

| é–¢æ•° | å‡¦ç†å†…å®¹ |
| :--- | :--- |
| `CalculateChecksum()` | æ§‹é€ ä½“ã®ãƒ‡ãƒ¼ã‚¿éƒ¨ã‚’åˆè¨ˆã—ã€`BYTE`åž‹ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’ç®—å‡ºã€‚ |
| `I2C_Master_Write()` | Start â†’ Slave Address + Write â†’ Data â†’ Stop ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å®Ÿè¡Œã€‚ |
| `I2C_Master_Read()` | Start â†’ Slave Address + Read â†’ RCEN (å—ä¿¡) â†’ ACK/NACK â†’ Stop ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã‚’å®Ÿè¡Œã€‚ |

-----

## 3\. ðŸŽ Arduino (ã‚¹ãƒ¬ãƒ¼ãƒ–) å´ã®å®Ÿè£…ã¨ãƒ­ã‚¸ãƒƒã‚¯

Arduinoã‚¹ã‚±ãƒƒãƒã¯ã€`Wire.h`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã€PICãƒžã‚¹ã‚¿ãƒ¼ã‹ã‚‰ã®è¦æ±‚ï¼ˆWriteã¾ãŸã¯Readï¼‰ã«è‡ªå‹•çš„ã«å¿œç­”ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•åž‹ã§ã™ã€‚

### 3.1. `setup()` é–¢æ•°ã®ä¿®æ­£

IÂ²Cã‚¹ãƒ¬ãƒ¼ãƒ–ã‚¢ãƒ‰ãƒ¬ã‚¹ (`0x37`) ã§IÂ²Cã‚’åˆæœŸåŒ–ã—ã€åŒæ–¹å‘é€šä¿¡ã®ãŸã‚ã®2ã¤ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã—ã¾ã™ã€‚

```cpp
Wire.onRequest(requestEvent); // PICãŒãƒ‡ãƒ¼ã‚¿ã‚’ã€Œèª­ã¿å‡ºã—ã€ã«æ¥ãŸã¨ã (Arduinoé€ä¿¡)
Wire.onReceive(receiveEvent); // PICãŒãƒ‡ãƒ¼ã‚¿ã‚’ã€Œæ›¸ãè¾¼ã¿ã€ã«æ¥ãŸã¨ã (Arduinoå—ä¿¡)
```

### 3.2. é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ (`requestEvent`)

PICãŒ`SensorData_t`ã‚’èª­ã¿å‡ºã™è¦æ±‚ã‚’ã—ãŸéš›ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

1.  æœ€æ–°ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆ`TxSensorData`ï¼‰ã‚’å–å¾—ãƒ»æ›´æ–°ã€‚
2.  ãƒã‚§ãƒƒã‚¯ã‚µãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤ããƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’è¨ˆç®—ã—ã€`checksum`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ ¼ç´ã€‚
3.  `Wire.write((const byte*)&TxSensorData, sizeof(SensorData_t));` ã§æ§‹é€ ä½“å…¨ä½“ã‚’é€ä¿¡ã€‚

### 3.3. å—ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ (`receiveEvent`)

PICãŒ`ControlData_t`ã‚’æ›¸ãè¾¼ã‚“ã§ããŸéš›ã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

1.  `byteCount`ã¨`sizeof(ControlData_t)`ã‚’æ¯”è¼ƒã—ã€ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã€‚
2.  `Wire.read()`ã§å—ä¿¡ã—ãŸãƒã‚¤ãƒˆåˆ—ã‚’ã€`RxControlData`æ§‹é€ ä½“ã«ç›´æŽ¥ã‚³ãƒ”ãƒ¼ã€‚
3.  å—ä¿¡ã—ãŸãƒã‚§ãƒƒã‚¯ã‚µãƒ ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å†è¨ˆç®—ã—ãŸãƒã‚§ãƒƒã‚¯ã‚µãƒ ã‚’æ¯”è¼ƒã—ã€ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã‹å¦ã‹ã‚’æ¤œè¨¼ã€‚**ï¼ˆæœ€é‡è¦ï¼‰**

